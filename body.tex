% For formatting purposes only 
\setcounter{chapter}{6}
\setcounter{section}{7}
\setcounter{subsection}{3}
%\listofalgorithms - think about it ...
%--------------
%- COPY START -
%--------------
\paragraph{Idea:} The \emph{constraints} (ex. weather, airspace) usually covers large portion of the \emph{operation airspace}. 

Converting constraints into valued \emph{point-cloud} is not feasible, due the \emph{huge amount of created points} and low \emph{intersection rate}. The \emph{polygon intersection} or \emph{circular boundary of 2D polygon} is simple and effective solution \cite{ritter1990efficient,welzl1991smallest}. 

The key idea is to create \emph{constraint barrels} around dangerous areas. Each \emph{constraint barrel} is defined by circle on \emph{horizontal plane} and \emph{vertical limit range}.

\paragraph{Representation:} The \emph{minimal representation} is based on (sec. \ref{sec:WellClear}, \ref{sec:WeatherImpact}) and geo-fencing principle. The \emph{horizontal-vertical separation} is ensured by \emph{projecting boundary} as 2D polygon oh horizontal plane and \emph{vertical boundary} (barrel height) as \emph{altitude limit}. 

The \emph{static constraint} (eq. \ref{eq:staticConstraint}) is defined as structure vector including:
\begin{enumerate}
    \item \emph{Position} - the center position in global coordinates\emph{2D horizontal plane}.
    
    \item \emph{Boundary} - the ordered set of boundary points forming edges in global coordinates\emph{2D horizontal plane}.
    
    \item \emph{Altitude Range} - the \emph{barometric altitude} range $[altitude_{start},$ $altitude_{end}]$.
    
    \item \emph{Safety Margin} - the \emph{protection zone} (soft constraint) around constraint body (hard constraints) in meters.
\end{enumerate}

\begin{multline}\label{eq:staticConstraint}
    constraint = \{position,boundary, altitude_{start},altitude_{end}, safety Margin\}
\end{multline}

\paragraph{Active constrain selection:} The \emph{active constraints} are constraints which are impacting \emph{UAS active avoidance range}. 

The \emph{active constraints set} (eq. \ref{eq:activeConstraintSet}) is defined as set of \emph{constraints} from all \emph{reliable Information Sources} where the \emph{the distance} between UAS and constraint body (including safety margin) is lesser than the avoidance grid range. The \emph{horizontal altitude range} of avoidance grid musts also intersect with \emph{constraint altitude range}.

\begin{multline}\label{eq:activeConstraintSet}
    Active Constraints = \dots\\\dots =
    \left\{\begin{aligned}constraint& \in Information Source:\\ 
    &distance(constraint,UAS) \le Avoidance Grid. distance,\\
    &constraint.altitude Range \cap UAS.altitude Range \neq \varnothing 
    \end{aligned}\right\}
\end{multline}

\paragraph{Cell Intersection:} The \emph{importance of constraints} is on their impact on \emph{avoidance grid} $cells$. The \emph{most of the constraints} (weather, ATC) are represented as 2D convex polygons. Even the \emph{irregularly shaped constraints} are usually split into smaller convex 2D polygons.

The idea is to represent convex polygon boundary as sufficiently large circle to cover polygon. The Welzl algorithm to find \emph{minimal polygon cover circle} \cite{welzl1991smallest} is used.

First the \emph{set of contraint edges} (eq. \ref{eq:constraintEdgeSet}) is a enclosed set of 2D edges between neighboring points defined as follow:

\begin{equation}\label{eq:constraintEdgeSet}
    edges(constraint) =
    \left\{
    \begin{bmatrix}
        point_{i},point_{j}
    \end{bmatrix}:
    \begin{aligned}
    &point\in boundary,\\
    &i \in \{1,\dots,|boundary|\},\\
    &j \in \{2,\dots, |boundary|,1\}\\
    \end{aligned}
    \right\}
\end{equation}

\noindent The \emph{constraint circle boundary} with calculated center on 2D horizontal plane and radius (representing body margin) is defined in (eq. \ref{eq:constraintCircleBoundary}).

\begin{equation}\label{eq:constraintCircleBoundary}
    circle(constraint)=
    \left[
        \begin{aligned}
            & center = \frac{\sum boundary.point}{|boundary.point|} + correction \quad \cite{welzl1991smallest}\\
            & radius = smallest Circle(edges(constraints)) \quad\cite{welzl1991smallest}
        \end{aligned}
    \right]
\end{equation}

\noindent The $(cell_{i,j,k}$ and \emph{constraint} intersection (eq. \ref{eq:contraintToCellIntersection}) is classification function. The \emph{classification} is necessary, because one \emph{constraint} induce: 
\begin{enumerate}
    \item \emph{Body Constraint} (hard constraint) - the distance between $cell_{i,j,k}$ closest border and \emph{circular boundary} center is in interval $[0,radius]$.
    
    \item \emph{Protection Zone Constraint} (soft constraint) - the distance between $cell_{i,j,k}$ closest border and \emph{circular boundary} center is in interval $]radius,radius+safety Margin]$.
\end{enumerate}


\begin{multline}\label{eq:contraintToCellIntersection}
    intersection,constraint)=\dots\\\dots = 
    \begin{cases}
        hard &:\left[
            \begin{aligned}
                &distance(cell_{i,j,k},circle(constraint)) \le\dots\\ 
                &\quad\dots\le circle(constraint).radius,\\
                & constraint.altitude Range \cap cell_{i,j,k}.altitude Range \neq \varnothing,
            \end{aligned}\right]\\
             &\\
        soft &:\left[
            \begin{aligned}
                &distance(cell_{i,j,k},circle(constraint)) >\dots\\ 
                &\quad\dots > circle(constraint).radius,\\
                &distance(cell_{i,j,k},circle(constraint)) \le\dots\\ 
                &\quad\dots\le circle(constraint).radius + safety Margin,\\
                & constraint.altitude Range \cap cell_{i,j,k}.altitude Range \neq \varnothing,
            \end{aligned}\right]\\
             &\\
        none &:otherwise
    \end{cases}
\end{multline}

\noindent The \emph{intersection impact} of constraint is handled separately for \emph{soft} and  \emph{hard} constraints. The \emph{avoidance} of hard constraints is \emph{mandatory}, the \emph{avoidance} of soft constraints is \emph{voluntary}.

The constraints which have an \emph{soft intersection with cell} are added to cells impacting constraints set: 
\begin{equation}\label{eq:softConstraintsCellIntersections}
    cell_{i,j,k}. soft Constraints = 
    \left\{
        \begin{aligned}
            &constraint \in Active Constraints:\\ 
            &\quad intersection(cell_{i,j,k},constraint) = soft
        \end{aligned}
    \right\}
\end{equation}

\noindent The constraints which have an \emph{hard intersection with cell} are added to cells impacting constraints set:

\begin{equation}\label{eq:hardConstraintsCellIntersections}
    cell_{i,j,k}. hard Constraints = 
    \left\{
        \begin{aligned}
            &constraint \in Active Constraints:\\ 
            &\quad intersection(cell_{i,j,k},constraint) = hard
        \end{aligned}
    \right\}
\end{equation}

\begin{note}
    The final \emph{constraint rate value} (eq. \ref{eq:constraintRatingForCell}) is determined based on \emph{mission control run} feed to \emph{avoidance grid} (fig. \ref{fig:missionControlRunActivityDiagram}) defined in 7\textsuperscript{th} to 10\textsuperscript{th} step.
\end{note}

\paragraph{Idea:} The basic ideas is the same as in case \emph{static constraints} (sec. \ref{s:virtualConstraints}). There is horizontal constraint and altitude constraint outlining the constrained space. The only additional concept is moving of \emph{constraint} on horizontal plane in global coordinate system. 

The constraint intersection  with \emph{avoidance grid} is done in \emph{fixed decision Time}, for cell in \emph{fixed cell leave time} (eq. \ref{eq:cellLeaveTime}), which means concept from static obstacles can be fully reused.

\paragraph{Definition:} The \emph{moving constraint definition} (eq. \ref{eq:movingConstraintDefinition}) covers minimal data scope for  moving constraint, assuming linear constraint movement. 

The original definition (eq. \ref{eq:staticConstraint}) is enhanced with additional parameters to support constraint moving:

\begin{enumerate}
    \item \emph{Velocity} - velocity vector on 2D horizontal plane.
    
    \item \emph{Detection time} - the time when \emph{constraint} was created/detected, this is the time when \emph center and boundary points position were valid.
\end{enumerate}

\begin{multline}\label{eq:movingConstraintDefinition}
    constraint = \{position,boundary,\dots\\\dots, velocity, detection Time, \dots \\\dots altitude_{start},altitude_{end}, safety Margin\}
\end{multline}

\paragraph{Cell Intersection:} The \emph{intersection algorithm} follows (eq. \ref{eq:contraintToCellIntersection}), only shift of the \emph{center and boundary points} is required. 

First let us introduce $\Delta time$ (eq. \ref{eq:deltatimeMovingconst}), which represents difference between the constraint detection time and expected cell leave time (eq. \ref{eq:cellLeaveTime}).

\begin{equation}\label{eq:deltatimeMovingconst}
    \Delta time = UAS_{leave}(cell_{i,j,k}) - detection Time
\end{equation}

\noindent The constraint boundary is shifted to:

\begin{multline}
    shifted Boundary(constraint) = \{new Point = point + velocity \times \Delta time:\dots\\\dots \forall point \in constraint.boundary \}
\end{multline}

\noindent The constraint center is shifted to:

\begin{equation}
    shifted Center(constraint) = constraint.center + velocity
\end{equation}

\begin{note}
    The $\Delta time$ is calculated separately for each $cell_{i,j,k}$, because \emph{UAS} is also  moving and reaching cells in different times. The \emph{cell leave time} can be calculated in advance after reach set approximation.
\end{note}


\paragraph{Alternative Intersection Implementation:} The alternative used for intersection selected based on polygon intersection algorithms review \citep{bentley1979algorithms}, the selected algorithm  is \emph{Shamos-Hoey} \cite{shamos1976geometric}.

The implementation was tested on \emph{Storm scenario} (sec. \ref{s:testStorm}) and it yelds same results.